# 自衛隊式スマートホーム規律システム
# Home Assistant Automations
# Version: 6.1 - 朝スケジュール改訂版
#
# 変更点 (v6.1):
# - 朝スケジュールを10分前倒し（父05:40起床、娘05:50起床）
# - ラジオ体操（06:12）を追加（TTS + YouTube再生）
# - 登園準備を06:45に前倒し（トイレ・着替え時間確保）
# - 06:20/06:25の重複通知を削除
#
# 変更点 (v6.0):
# - 夜フェーズを固定時刻から「帰宅時刻基準」の動的スケジュールに変更
# - 完了済みタスクのスキップ機能を追加
# - 宿題時間を新規追加
# - 定時「おかえり」を廃止、GPS検知のみに統一

# =============================================================================
# デバイス設定
# -----------------------------------------------------------------------------
# スピーカー:
#   書斎: media_player.shu_zhai_nohea (父専用 + 娘の部屋通知代替)
#   リビング: media_player.shu_zhai_hetuto_hou_you (リビング/洗面/玄関エリア)
#   子供部屋: [未導入] media_player.kodomo_heya (導入後に有効化)
# -----------------------------------------------------------------------------
# 照明 (すべてlight.turn_on/turn_off対応):
#   書斎: light.shu_zhai
#   子供部屋: light.zi_gong_bu_wu
#   リビング: light.rihinku
#   寝室: light.qin_shi
#   廊下/玄関: light.lang_xia
# -----------------------------------------------------------------------------
# Nature Remo センサー:
#   温度: sensor.temperature_sensor_rihinku, _shu_zhai, _lang_xia, _remo
#   湿度: sensor.humidity_sensor_rihinku, _shu_zhai, _lang_xia, _remo
#   照度: sensor.illuminance_sensor_rihinku, _shu_zhai, _lang_xia, _remo
#   人感: sensor.movement_sensor_rihinku, _shu_zhai, _lang_xia, _remo (最終検知時刻)
# -----------------------------------------------------------------------------
# その他:
#   サーキュレーター: button.send_signal_sakiyureta (全部屋一括)
#   GPS/Person: person.ri_xia (日下)
# -----------------------------------------------------------------------------
# Helper Entity (作成済み):
#   input_datetime.shi_ji_nogui_zhai_shi_guo - 実際の帰宅時刻
#   input_boolean.ye_ruteinkai_shi - 夜ルーティン開始フラグ
#   input_boolean.su_ti_wan_liao - 宿題完了フラグ
#   input_boolean.xi_shi_wan_liao - 夕食完了フラグ
#   input_boolean.ru_yu_wan_liao - 入浴完了フラグ
#   input_boolean.jiu_qin_zhun_bei_wan_liao - 就寝準備完了フラグ
# =============================================================================

# =============================================================================
# 朝フェーズ
# =============================================================================

# 父・起床（05:40）
- id: father_wakeup
  alias: "父・起床"
  description: "父の起床時刻"
  trigger:
    - platform: time
      at: "05:40:00"
  condition:
    - condition: state
      entity_id: input_boolean.workday
      state: "on"
  action:
    # 書斎・リビング・廊下を点灯（常夜灯→通常モード）
    - service: light.turn_on
      target:
        entity_id:
          - light.shu_zhai
          - light.rihinku
          - light.lang_xia
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おはようございます。起床時刻です。"
        language: ja

# 娘・起床（05:50）- 強制
- id: daughter_wakeup
  alias: "娘・起床"
  description: "娘の起床時刻（強制）"
  trigger:
    - platform: time
      at: "05:50:00"
  action:
    - service: light.turn_on
      target:
        entity_id: light.zi_gong_bu_wu
    # 書斎スピーカー（子供部屋代替）
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おはようございます。起床時刻です。着替えとベッドメイクを始めてください。"
        language: ja

# 父・朝食準備開始（05:50）
- id: father_breakfast_prep
  alias: "父・朝食準備開始"
  trigger:
    - platform: time
      at: "05:50:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "朝食準備を始めてください。"
        language: ja

# 娘・着替え確認（05:55）
- id: daughter_clothes_check
  alias: "娘・着替え確認"
  trigger:
    - platform: time
      at: "05:55:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "着替えは終わりましたか？次はベッドメイクです。"
        language: ja

# 娘・洗面指示（06:00）
- id: daughter_wash_instruction
  alias: "娘・洗面指示"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "洗面台に移動してください。顔を洗って歯を磨きましょう。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "洗面台に移動してください。顔を洗って歯を磨きましょう。"
        language: ja

# ラジオ体操（06:12）- 朝のルーティンに追加
- id: radio_taiso
  alias: "ラジオ体操"
  description: "朝のラジオ体操第一（TTS + 音楽再生）"
  trigger:
    - platform: time
      at: "06:12:00"
  action:
    # 1. TTS告知
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ラジオ体操の時間です。リビングに集まってください。"
        language: ja
    - delay:
        seconds: 8
    # 2. ラジオ体操第一の音楽を再生（YouTube）
    - service: media_player.play_media
      target:
        entity_id: media_player.shu_zhai_hetuto_hou_you
      data:
        media_content_id: "https://www.youtube.com/watch?v=RmjQNmxILMg"
        media_content_type: video/youtube

# 朝食点呼（06:20）
- id: breakfast_call
  alias: "朝食点呼"
  trigger:
    - platform: time
      at: "06:20:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "朝食の時間です。いただきます。"
        language: ja

# 朝のかくにんタイム（06:22）- 平日版
- id: morning_checkin_weekday
  alias: "朝のかくにんタイム（平日）"
  trigger:
    - platform: time
      at: "06:22:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
        - sat
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "朝のかくにんタイムです。今日の気分と、やりたいことを教えてください。おとうさんからどうぞ。"
        language: ja

# 朝のかくにんタイム（06:22）- 日曜版（週礼）
- id: morning_checkin_sunday
  alias: "朝のかくにんタイム（日曜）"
  trigger:
    - platform: time
      at: "06:22:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "日曜の朝のかくにんタイムです。今週たのしかったことと、来週のたのしみを教えてください。おとうさんからどうぞ。"
        language: ja

# 登園準備開始（06:45）- 15分前倒しでトイレ・着替え時間確保
- id: departure_prep_start
  alias: "登園準備開始"
  trigger:
    - platform: time
      at: "06:45:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ごちそうさまでした。トイレと着替えをしてください。登園の準備を始めましょう。"
        language: ja

# 出発5分前（07:10）
- id: departure_5min_before
  alias: "出発5分前"
  trigger:
    - platform: time
      at: "07:10:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "出発5分前です。靴を履いて玄関で待機してください。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "出発5分前です。靴を履いて玄関で待機してください。"
        language: ja

# 出発（07:15）- 照明OFF
- id: departure
  alias: "出発"
  trigger:
    - platform: time
      at: "07:15:00"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.qin_shi
          - light.lang_xia
          - light.zi_gong_bu_wu

# 在宅勤務開始（07:45）
- id: work_start
  alias: "在宅勤務開始"
  trigger:
    - platform: time
      at: "07:45:00"
  condition:
    - condition: state
      entity_id: input_boolean.father_home
      state: "on"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おかえりなさい。勤務時間です。"
        language: ja

# =============================================================================
# 夜フェーズ（動的スケジュール）
# =============================================================================
# スケジュール: 帰宅 → +5分: 帰宅後作業 → +15分: 宿題 → +25分: 夕食
#              → +55分: 入浴 → +75分: 歯磨き → +90分: 就寝準備 → +100分: 就寝
# =============================================================================

# お迎え準備（18:00）- 固定時刻
- id: pickup_reminder
  alias: "お迎え準備"
  trigger:
    - platform: time
      at: "18:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "お迎えの時間が近づいています。18時15分に出発です。"
        language: ja

# -----------------------------------------------------------------------------
# 夜ルーティン・リセット（毎日17:00）
# -----------------------------------------------------------------------------
- id: evening_routine_reset
  alias: "夜ルーティン・リセット"
  description: "毎日17:00に夜ルーティンフラグをリセット"
  trigger:
    - platform: time
      at: "17:00:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id:
          - input_boolean.ye_ruteinkai_shi
          - input_boolean.su_ti_wan_liao
          - input_boolean.xi_shi_wan_liao
          - input_boolean.ru_yu_wan_liao
          - input_boolean.jiu_qin_zhun_bei_wan_liao

# -----------------------------------------------------------------------------
# GPS帰宅検知 → 夜ルーティン開始（動的）
# -----------------------------------------------------------------------------
- id: gps_arriving_home_dynamic
  alias: "GPS・帰宅検知（動的スケジュール）"
  description: "帰宅時に時刻を記録し、夜ルーティンを開始"
  trigger:
    - platform: state
      entity_id: person.ri_xia
      from: "not_home"
      to: "home"
  condition:
    # 夕方以降のみ（17:00-21:00）
    - condition: time
      after: "17:00:00"
      before: "21:00:00"
    # まだ夜ルーティンが開始していない場合のみ
    - condition: state
      entity_id: input_boolean.ye_ruteinkai_shi
      state: "off"
  action:
    # 1. 帰宅時刻を記録
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.shi_ji_nogui_zhai_shi_guo
      data:
        time: "{{ now().strftime('%H:%M:%S') }}"
    # 2. 夜ルーティン開始フラグをON
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.ye_ruteinkai_shi
    # 3. 日没後なら照明ON
    - condition: sun
      after: sunset
    - service: light.turn_on
      target:
        entity_id:
          - light.rihinku
          - light.lang_xia
    # 4. おかえりなさい
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "おかえりなさい。"
        language: ja

# -----------------------------------------------------------------------------
# GPS帰宅検知フォールバック（19:00）
# -----------------------------------------------------------------------------
- id: evening_routine_fallback
  alias: "夜ルーティン・フォールバック"
  description: "19:00までに帰宅検知できなかった場合、19:00を帰宅時刻として開始"
  trigger:
    - platform: time
      at: "19:00:00"
  condition:
    # まだ夜ルーティンが開始していない場合のみ
    - condition: state
      entity_id: input_boolean.ye_ruteinkai_shi
      state: "off"
  action:
    # 1. 帰宅時刻を19:00に設定
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.shi_ji_nogui_zhai_shi_guo
      data:
        time: "19:00:00"
    # 2. 夜ルーティン開始フラグをON
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.ye_ruteinkai_shi
    # 3. 日没後なら照明ON
    - condition: sun
      after: sunset
    - service: light.turn_on
      target:
        entity_id:
          - light.rihinku
          - light.lang_xia
    # 4. フォールバック通知
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "夜のルーティンを開始します。"
        language: ja

# -----------------------------------------------------------------------------
# 帰宅後作業（帰宅+5分）
# -----------------------------------------------------------------------------
- id: dynamic_home_chores
  alias: "帰宅後作業（動的）"
  description: "帰宅5分後に手洗い等の指示"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=5) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "手洗い、洗濯機、お風呂の準備をお願いします。"
        language: ja

# -----------------------------------------------------------------------------
# 宿題開始（帰宅+15分）- 新規追加
# -----------------------------------------------------------------------------
- id: dynamic_homework_start
  alias: "宿題開始（動的）"
  description: "帰宅15分後に宿題・デスク時間開始"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=15) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  condition:
    - condition: state
      entity_id: input_boolean.su_ti_wan_liao
      state: "off"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "宿題の時間です。机に向かってお勉強しましょう。10分間集中してね。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "宿題の時間です。机に向かってお勉強しましょう。"
        language: ja

# -----------------------------------------------------------------------------
# 夕食開始（帰宅+25分）
# -----------------------------------------------------------------------------
- id: dynamic_dinner_start
  alias: "夕食開始（動的）"
  description: "帰宅25分後に夕食開始"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=25) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  condition:
    - condition: state
      entity_id: input_boolean.xi_shi_wan_liao
      state: "off"
  action:
    # 宿題完了をマーク
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.su_ti_wan_liao
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "夕食の時間です。いただきます。"
        language: ja

# -----------------------------------------------------------------------------
# 入浴開始（帰宅+55分）
# -----------------------------------------------------------------------------
- id: dynamic_bath_start
  alias: "入浴開始（動的）"
  description: "帰宅55分後に入浴開始"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=55) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  condition:
    - condition: state
      entity_id: input_boolean.ru_yu_wan_liao
      state: "off"
  action:
    # 夕食完了をマーク
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.xi_shi_wan_liao
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ごちそうさまでした。お風呂の時間です。"
        language: ja

# -----------------------------------------------------------------------------
# 歯磨き（帰宅+75分）
# -----------------------------------------------------------------------------
- id: dynamic_teeth_brushing
  alias: "歯磨き（動的）"
  description: "帰宅75分後に歯磨き指示"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=75) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  condition:
    - condition: state
      entity_id: input_boolean.ru_yu_wan_liao
      state: "off"
  action:
    # 入浴完了をマーク
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.ru_yu_wan_liao
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "お風呂お疲れさまでした。洗面台で歯を磨いてください。"
        language: ja

# -----------------------------------------------------------------------------
# 就寝準備（帰宅+90分）
# -----------------------------------------------------------------------------
- id: dynamic_bedtime_prep
  alias: "就寝準備（動的）"
  description: "帰宅90分後に就寝準備（巡検・布団）"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=90) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  condition:
    - condition: state
      entity_id: input_boolean.jiu_qin_zhun_bei_wan_liao
      state: "off"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "巡検の時間です。明日の服と持ち物を見せてください。確認したら布団に入る準備をしましょう。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "巡検の時間です。明日の服と持ち物を見せてください。"
        language: ja
    # サーキュレーターOFF
    - service: button.press
      target:
        entity_id: button.send_signal_sakiyureta

# -----------------------------------------------------------------------------
# 娘・就寝（帰宅+100分）
# -----------------------------------------------------------------------------
- id: dynamic_daughter_sleep
  alias: "娘・就寝（動的）"
  description: "帰宅100分後に娘就寝（強制消灯）"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=100) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  action:
    # 就寝準備完了をマーク
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.jiu_qin_zhun_bei_wan_liao
    # 子供部屋消灯
    - service: light.turn_off
      target:
        entity_id: light.zi_gong_bu_wu
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おやすみなさい。"
        language: ja

# -----------------------------------------------------------------------------
# 父・洗濯物干し（娘就寝と同時）
# -----------------------------------------------------------------------------
- id: dynamic_father_laundry
  alias: "父・洗濯物干し（動的）"
  description: "娘就寝時に洗濯物干しリマインド"
  trigger:
    - platform: template
      value_template: >
        {% set arrival = states('input_datetime.shi_ji_nogui_zhai_shi_guo') %}
        {% if arrival not in ['unknown', 'unavailable', ''] and is_state('input_boolean.ye_ruteinkai_shi', 'on') %}
          {% set arrival_time = today_at(arrival) %}
          {% set target_time = arrival_time + timedelta(minutes=100) %}
          {{ now() >= target_time and now() < target_time + timedelta(minutes=1) }}
        {% else %}
          false
        {% endif %}
  action:
    - delay:
        seconds: 5
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "洗濯物を干す時間です。"
        language: ja

# =============================================================================
# 父・就寝（固定時刻）
# =============================================================================

# 父・就寝5分前（21:55）
- id: father_sleep_5min_before
  alias: "父・就寝5分前"
  trigger:
    - platform: time
      at: "21:55:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "就寝5分前です。"
        language: ja

# 父・就寝（22:00）- 全館消灯
- id: father_sleep
  alias: "父・就寝"
  description: "父の就寝時刻（廊下は常夜灯モードに切替）"
  trigger:
    - platform: time
      at: "22:00:00"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.rihinku
          - light.qin_shi
          - light.shu_zhai
    - service: select.select_option
      target:
        entity_id: select.signals_lang_xia
      data:
        option: "4. night"
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おやすみなさい。"
        language: ja

# =============================================================================
# Phase 2: 夜泣き対応（2026年2月〜有効化）
# =============================================================================

- id: night_cry_detection
  alias: "夜泣き検知"
  description: "深夜に寝室照明がONになったら夜泣きモードを有効化"
  trigger:
    - platform: state
      entity_id: light.qin_shi
      to: "on"
  condition:
    - condition: time
      after: "00:00:00"
      before: "05:00:00"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.night_cry_mode
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.mother_wakeup_time
      data:
        time: "07:00:00"

- id: night_cry_reset
  alias: "夜泣きモードリセット"
  trigger:
    - platform: time
      at: "06:30:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.night_cry_mode
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.mother_wakeup_time
      data:
        time: "06:30:00"

# =============================================================================
# ユーティリティ
# =============================================================================

- id: holiday_mode_on
  alias: "休日モードON"
  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: input_boolean
        service: turn_off
        service_data:
          entity_id: input_boolean.workday
  action:
    - service: automation.turn_off
      target:
        entity_id:
          - automation.father_wakeup
          - automation.daughter_wakeup

- id: father_away_mode
  alias: "父外出モード"
  trigger:
    - platform: state
      entity_id: input_boolean.father_home
      to: "off"
  action:
    - service: automation.turn_off
      target:
        entity_id:
          - automation.work_start
          - automation.pickup_reminder

# =============================================================================
# ゴミ出しリマインダー
# =============================================================================

- id: garbage_cardboard_reminder
  alias: "ゴミ出し・段ボール"
  description: "毎月第4土曜日の前日夜にリマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().weekday() == 4 and 22 <= (now().day + 1) <= 28 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は段ボールごみの日です。段ボールをまとめて出してください。"
        language: ja

- id: garbage_nonburnable_reminder
  alias: "ゴミ出し・燃えないゴミ/ペットボトル"
  description: "毎月第1・3・5木曜日の前日夜にリマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: >
        {{ now().weekday() == 2 and
           (1 <= (now().day + 1) <= 7 or
            15 <= (now().day + 1) <= 21 or
            29 <= (now().day + 1) <= 31) }}
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は燃えないゴミとペットボトルの日です。分別して出してください。"
        language: ja

- id: garbage_bulky_20260127
  alias: "ゴミ出し・粗大ごみ（2026/1/27）"
  description: "2026年1月27日の粗大ごみ収集前日リマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().month == 1 and now().day == 26 and now().year == 2026 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は粗大ごみの収集日です。出す予定のものを玄関に準備してください。"
        language: ja

# =============================================================================
# お弁当の日リマインダー
# =============================================================================

- id: bento_prep_reminder
  alias: "お弁当・前日準備"
  description: "毎月第3水曜日の前日夜にリマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().weekday() == 1 and 15 <= (now().day + 1) <= 21 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日はお弁当の日です。お弁当の材料を確認して、準備をお願いします。"
        language: ja

- id: bento_morning_reminder
  alias: "お弁当・当日朝"
  description: "毎月第3水曜日の朝にリマインド"
  trigger:
    - platform: time
      at: "05:50:00"
  condition:
    - condition: template
      value_template: "{{ now().weekday() == 2 and 15 <= now().day <= 21 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "今日はお弁当の日です。お弁当の準備を忘れずに。"
        language: ja

# =============================================================================
# 特別イベントリマインダー
# =============================================================================

- id: event_performance_prep_20260207
  alias: "発表会・前日準備（2026/2/7）"
  description: "2026年2月7日の発表会前日リマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().year == 2026 and now().month == 2 and now().day == 6 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は発表会です。衣装と持ち物を確認して、早めに寝ましょう。"
        language: ja

- id: event_performance_day_20260207
  alias: "発表会・当日（2026/2/7）"
  description: "2026年2月7日の発表会当日リマインド"
  trigger:
    - platform: time
      at: "06:00:00"
  condition:
    - condition: template
      value_template: "{{ now().year == 2026 and now().month == 2 and now().day == 7 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "今日は発表会です。がんばってね！衣装と持ち物を忘れずに。"
        language: ja

# =============================================================================
# GPS/プレゼンス連動
# =============================================================================

- id: gps_leaving_home
  alias: "GPS・外出検知"
  description: "外出5分後に書斎の照明をOFF"
  trigger:
    - platform: state
      entity_id: person.ri_xia
      from: "home"
      to: "not_home"
      for:
        minutes: 5
  action:
    - service: light.turn_off
      target:
        entity_id: light.shu_zhai

# =============================================================================
# サーキュレーター時間制御
# =============================================================================

- id: circulator_morning_on
  alias: "サーキュレーター・朝ON"
  description: "朝5:50にサーキュレーター起動"
  trigger:
    - platform: time
      at: "05:50:00"
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
  action:
    - service: button.press
      target:
        entity_id: button.send_signal_sakiyureta

# 夜のサーキュレーターOFFは就寝準備（dynamic_bedtime_prep）で実行

# =============================================================================
# 温度アラート
# =============================================================================

- id: temperature_alert_living_high
  alias: "温度アラート・リビング高温"
  description: "リビングが28℃を超えたら音声通知"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_sensor_rihinku
      above: 28
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
    - condition: time
      after: "06:00:00"
      before: "21:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "リビングの室温が{{ states('sensor.temperature_sensor_rihinku') }}度です。エアコンの使用を検討してください。"
        language: ja

- id: temperature_alert_study_high
  alias: "温度アラート・書斎高温"
  description: "書斎が28℃を超えたら音声通知"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_sensor_shu_zhai
      above: 28
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
    - condition: time
      after: "06:00:00"
      before: "21:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "書斎の室温が{{ states('sensor.temperature_sensor_shu_zhai') }}度です。エアコンの使用を検討してください。"
        language: ja

- id: temperature_alert_living_low
  alias: "温度アラート・リビング低温"
  description: "リビングが15℃以下になったら音声通知"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_sensor_rihinku
      below: 15
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
    - condition: time
      after: "06:00:00"
      before: "21:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "リビングの室温が{{ states('sensor.temperature_sensor_rihinku') }}度です。暖房の使用を検討してください。"
        language: ja

# =============================================================================
# スピーカー音量制御
# =============================================================================
# 音量レベル: 朝(0.7) → 夕方(0.5) → 夜(0.3)

# 朝・音量UP（05:40）- 起床時刻に合わせて大きめ
- id: speaker_volume_morning
  alias: "スピーカー音量・朝"
  description: "朝は音量を大きく（70%）"
  trigger:
    - platform: time
      at: "05:40:00"
  action:
    - service: media_player.volume_set
      target:
        entity_id:
          - media_player.shu_zhai_nohea
          - media_player.shu_zhai_hetuto_hou_you
      data:
        volume_level: 0.7

# 夕方・音量NORMAL（17:00）- 帰宅前に通常に戻す
- id: speaker_volume_evening
  alias: "スピーカー音量・夕方"
  description: "夕方は音量を普通に（50%）"
  trigger:
    - platform: time
      at: "17:00:00"
  action:
    - service: media_player.volume_set
      target:
        entity_id:
          - media_player.shu_zhai_nohea
          - media_player.shu_zhai_hetuto_hou_you
      data:
        volume_level: 0.5

# 夜・音量DOWN（21:00）- 娘就寝後は小さく
- id: speaker_volume_night
  alias: "スピーカー音量・夜"
  description: "夜は音量を小さく（30%）"
  trigger:
    - platform: time
      at: "21:00:00"
  action:
    - service: media_player.volume_set
      target:
        entity_id:
          - media_player.shu_zhai_nohea
          - media_player.shu_zhai_hetuto_hou_you
      data:
        volume_level: 0.3

# =============================================================================
# テレビ電源制御（Tapo P110M）
# =============================================================================
# 18:00〜06:00はテレビ視聴禁止（子供の生活リズム維持）

# 朝・テレビ電源ON（06:00）- ラジオ体操準備
- id: tv_power_morning_on
  alias: "テレビ電源・朝ON"
  description: "朝6時にテレビ電源ON（ラジオ体操用）"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.rihinkuterehihuraku

# 夕方・テレビ電源OFF（18:00）- 夜間視聴禁止
- id: tv_power_evening_off
  alias: "テレビ電源・夕方OFF"
  description: "18時にテレビ電源OFF（夜間視聴禁止）"
  trigger:
    - platform: time
      at: "18:00:00"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.rihinkuterehihuraku

# =============================================================================
# エアコン自動OFF（就寝時）
# =============================================================================

# 21時・エアコン全OFF（就寝準備）
- id: aircon_off_bedtime
  alias: "エアコン・就寝時OFF"
  description: "21時に全エアコンをOFF（就寝中の節電）"
  trigger:
    - platform: time
      at: "21:00:00"
  action:
    - service: climate.turn_off
      target:
        entity_id:
          - climate.qin_shi_noeakon_remo
          - climate.rihinkunoeakon_rihinku
          - climate.shu_zhai_noeakon_shu_zhai
          - climate.zi_gong_bu_wu_noeakon_lang_xia
