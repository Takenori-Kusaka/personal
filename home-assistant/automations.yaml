# 自衛隊式スマートホーム規律システム
# Home Assistant Automations
# Version: 6.4 - 日本祝日対応版
#
# 変更点 (v6.4):
# - 日本の祝日対応: binary_sensor.workday_sensor を使用
# - 登園準備: 祝日も自動でスキップ（曜日条件 → workdayセンサー）
# - 週次習慣: タオル交換、シーツ洗濯リマインダー追加（土曜07:00）
# - 月次習慣: 消耗品交換リマインダー追加（毎月1日06:00）
#
# 変更点 (v6.3):
# - ラジオ体操: webostv.command → media_player.play_media に変更（YouTube再生修正）
# - ラジオ体操: TV電源OFF待機を4分→5分30秒に延長
# - サーキュレーター: リビングのみに操作を限定
# - 登園準備: 平日（月〜金）条件を追加（土曜日除外）
#
# 変更点 (v6.2):
# - 夜フェーズを動的スケジュールから固定時刻に変更
# - テンプレートトリガーの信頼性問題を解消
# - 20:30就寝を基準に逆算したスケジュール
#
# 変更点 (v6.1):
# - 朝スケジュールを10分前倒し（父05:40起床、娘05:50起床）
# - ラジオ体操（06:12）を追加（TTS + YouTube再生）
# - 登園準備を06:45に前倒し（トイレ・着替え時間確保）
# - 06:20/06:25の重複通知を削除

# =============================================================================
# デバイス設定
# -----------------------------------------------------------------------------
# スピーカー:
#   書斎: media_player.shu_zhai_nohea (父専用)
#   リビング: media_player.shu_zhai_hetuto_hou_you (リビング/洗面/玄関エリア)
#   子供部屋: media_player.zi_gong_bu_wu (娘用)
# -----------------------------------------------------------------------------
# 照明 (すべてlight.turn_on/turn_off対応):
#   書斎: light.shu_zhai
#   子供部屋: light.zi_gong_bu_wu
#   リビング: light.rihinku
#   寝室: light.qin_shi
#   廊下/玄関: light.lang_xia
# -----------------------------------------------------------------------------
# Nature Remo センサー:
#   温度: sensor.temperature_sensor_rihinku, _shu_zhai, _lang_xia, _remo
#   湿度: sensor.humidity_sensor_rihinku, _shu_zhai, _lang_xia, _remo
#   照度: sensor.illuminance_sensor_rihinku, _shu_zhai, _lang_xia, _remo
#   人感: sensor.movement_sensor_rihinku, _shu_zhai, _lang_xia, _remo (最終検知時刻)
# -----------------------------------------------------------------------------
# その他:
#   サーキュレーター（部屋別）:
#     リビング: button.send_signal_rihinkunosakiyureta
#     書斎: button.send_signal_shu_zhai_nosakiyureta
#     子供部屋: button.send_signal_sakiyureta
#     寝室: button.send_signal_qin_shi_nosakiyureta
#   GPS/Person: person.ri_xia (日下)
# -----------------------------------------------------------------------------
# Helper Entity (作成済み):
#   input_datetime.shi_ji_nogui_zhai_shi_guo - 実際の帰宅時刻
#   input_boolean.ye_ruteinkai_shi - 夜ルーティン開始フラグ
# =============================================================================

# =============================================================================
# 朝フェーズ
# =============================================================================

# 父・起床（05:40）
- id: father_wakeup
  alias: "父・起床"
  description: "父の起床時刻（平日・祝日除く）"
  trigger:
    - platform: time
      at: "05:40:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    # 書斎・リビング・廊下を点灯（常夜灯→通常モード）
    - service: light.turn_on
      target:
        entity_id:
          - light.shu_zhai
          - light.rihinku
          - light.lang_xia
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おはようございます。起床時刻です。"
        language: ja

# 娘・起床（05:50）- 強制
- id: daughter_wakeup
  alias: "娘・起床"
  description: "娘の起床時刻（強制）"
  trigger:
    - platform: time
      at: "05:50:00"
  action:
    - service: light.turn_on
      target:
        entity_id: light.zi_gong_bu_wu
    # 子供部屋スピーカー
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "おはようございます。起床時刻です。着替えとベッドメイクを始めてください。"
        language: ja

# 父・朝食準備開始（05:50）
- id: father_breakfast_prep
  alias: "父・朝食準備開始"
  trigger:
    - platform: time
      at: "05:50:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "朝食準備を始めてください。"
        language: ja

# 娘・着替え確認（05:55）
- id: daughter_clothes_check
  alias: "娘・着替え確認"
  trigger:
    - platform: time
      at: "05:55:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "着替えは終わりましたか？次はベッドメイクです。"
        language: ja

# 娘・洗面指示（06:00）
- id: daughter_wash_instruction
  alias: "娘・洗面指示"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    # リビング（洗面所に近い）
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "洗面台に移動してください。顔を洗って歯を磨きましょう。"
        language: ja
    - delay:
        seconds: 3
    # 子供部屋
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "洗面台に移動してください。顔を洗って歯を磨きましょう。"
        language: ja

# ラジオ体操（06:12）- 朝のルーティンに追加
- id: radio_taiso
  alias: "ラジオ体操"
  description: "朝のラジオ体操第一（TTS告知 + LG TVでYouTube再生 + 終了後TV OFF）"
  trigger:
    - platform: time
      at: "06:12:00"
  action:
    # 1. TTS告知
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ラジオ体操の時間です。テレビの前に集まってください。"
        language: ja
    - delay:
        seconds: 5
    # 2. LG TVの電源ON
    - service: media_player.turn_on
      target:
        entity_id: media_player.lg_webos_tv_55ur8000pjb
    - delay:
        seconds: 5
    # 3. ラジオ体操第一をLG TVで再生（YouTube）
    - service: media_player.play_media
      target:
        entity_id: media_player.lg_webos_tv_55ur8000pjb
      data:
        media_content_type: video
        media_content_id: "https://www.youtube.com/watch?v=f1T5rUipf2M"
    # 4. ラジオ体操終了まで待機（5分30秒 = 動画3分 + 広告/起動遅延）
    - delay:
        minutes: 5
        seconds: 30
    # 5. TV電源OFF（テレビ中毒対策）
    - service: media_player.turn_off
      target:
        entity_id: media_player.lg_webos_tv_55ur8000pjb
    - service: switch.turn_off
      target:
        entity_id: switch.rihinkuterehihuraku
    # 6. 朝食準備促し
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ラジオ体操おつかれさまでした。朝食の準備をしましょう。"
        language: ja

# 朝食点呼（06:20）
- id: breakfast_call
  alias: "朝食点呼"
  trigger:
    - platform: time
      at: "06:20:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "朝食の時間です。いただきます。"
        language: ja

# 朝のかくにんタイム（06:22）- 平日版
- id: morning_checkin_weekday
  alias: "朝のかくにんタイム（平日）"
  trigger:
    - platform: time
      at: "06:22:00"
  condition:
    - condition: time
      weekday:
        - mon
        - tue
        - wed
        - thu
        - fri
        - sat
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "朝のかくにんタイムです。今日の気分と、やりたいことを教えてください。おとうさんからどうぞ。"
        language: ja

# 朝のかくにんタイム（06:22）- 日曜版（週礼）
- id: morning_checkin_sunday
  alias: "朝のかくにんタイム（日曜）"
  trigger:
    - platform: time
      at: "06:22:00"
  condition:
    - condition: time
      weekday:
        - sun
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "日曜の朝のかくにんタイムです。今週たのしかったことと、来週のたのしみを教えてください。おとうさんからどうぞ。"
        language: ja

# 登園準備開始（06:45）- 15分前倒しでトイレ・着替え時間確保
- id: departure_prep_start
  alias: "登園準備開始"
  description: "平日のみ（祝日除く）"
  trigger:
    - platform: time
      at: "06:45:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ごちそうさまでした。トイレと着替えをしてください。登園の準備を始めましょう。"
        language: ja

# 出発5分前（07:10）
- id: departure_5min_before
  alias: "出発5分前"
  description: "平日のみ（祝日除く）"
  trigger:
    - platform: time
      at: "07:10:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "出発5分前です。靴を履いて玄関で待機してください。"
        language: ja
    - delay:
        seconds: 3
    # 子供部屋
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "出発5分前です。靴を履いて玄関で待機してください。"
        language: ja

# 出発（07:15）- 照明OFF
- id: departure
  alias: "出発"
  description: "平日のみ（祝日除く）"
  trigger:
    - platform: time
      at: "07:15:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.qin_shi
          - light.lang_xia
          - light.zi_gong_bu_wu

# 在宅勤務開始（07:45）
- id: work_start
  alias: "在宅勤務開始"
  description: "平日のみ（祝日除く）"
  trigger:
    - platform: time
      at: "07:45:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
    - condition: state
      entity_id: input_boolean.father_home
      state: "on"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おかえりなさい。勤務時間です。"
        language: ja

# =============================================================================
# 夜フェーズ（固定時刻スケジュール）
# =============================================================================
# スケジュール（20:30ベッドイン、21:00就寝を基準）:
#   18:00 - お迎え準備 + サーキュレーターOFF + TV電源OFF
#   19:00 - 帰宅（GPS検知またはフォールバック）
#   19:05 - 帰宅後作業（手洗い、着替え、洗濯準備、お風呂掃除・沸かす）
#   19:15 - 夕食
#   19:45 - 食器片付け
#   19:50 - お風呂
#   20:05 - 風呂上がり（保湿・パジャマ）
#   20:10 - 洗濯物干し・明日の準備
#   20:20 - 歯磨き・宿題 + サーキュレーターOFF
#   20:28 - トイレ・寝る準備
#   20:30 - ベッドに入る（リビング消灯・廊下常夜灯・TV電源OFF）
#   20:45 - 子供部屋消灯
#   21:00 - 就寝（実際に寝る時間）
# =============================================================================

# お迎え準備（18:00）- 固定時刻
- id: pickup_reminder
  alias: "お迎え準備"
  description: "平日のみ（祝日除く）"
  trigger:
    - platform: time
      at: "18:00:00"
  condition:
    - condition: state
      entity_id: binary_sensor.workday_sensor
      state: "on"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "お迎えの時間が近づいています。18時15分に出発です。"
        language: ja

# -----------------------------------------------------------------------------
# 夜ルーティン・リセット（毎日17:00）
# -----------------------------------------------------------------------------
- id: evening_routine_reset
  alias: "夜ルーティン・リセット"
  description: "毎日17:00に夜ルーティンフラグをリセット"
  trigger:
    - platform: time
      at: "17:00:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.ye_ruteinkai_shi

# -----------------------------------------------------------------------------
# GPS帰宅検知 → 夜ルーティン開始
# -----------------------------------------------------------------------------
- id: gps_arriving_home
  alias: "GPS・帰宅検知"
  description: "帰宅時に時刻を記録し、夜ルーティンを開始"
  trigger:
    - platform: state
      entity_id: person.ri_xia
      from: "not_home"
      to: "home"
  condition:
    # 夕方以降のみ（17:00-21:00）
    - condition: time
      after: "17:00:00"
      before: "21:00:00"
    # まだ夜ルーティンが開始していない場合のみ
    - condition: state
      entity_id: input_boolean.ye_ruteinkai_shi
      state: "off"
  action:
    # 1. 帰宅時刻を記録
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.shi_ji_nogui_zhai_shi_guo
      data:
        time: "{{ now().strftime('%H:%M:%S') }}"
    # 2. 夜ルーティン開始フラグをON
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.ye_ruteinkai_shi
    # 3. 日没後なら照明ON
    - condition: sun
      after: sunset
    - service: light.turn_on
      target:
        entity_id:
          - light.rihinku
          - light.lang_xia
    # 4. おかえりなさい
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "おかえりなさい。"
        language: ja

# -----------------------------------------------------------------------------
# GPS帰宅検知フォールバック（19:00）
# -----------------------------------------------------------------------------
- id: evening_routine_fallback
  alias: "夜ルーティン・フォールバック"
  description: "19:00までに帰宅検知できなかった場合、19:00を帰宅時刻として開始"
  trigger:
    - platform: time
      at: "19:00:00"
  condition:
    # まだ夜ルーティンが開始していない場合のみ
    - condition: state
      entity_id: input_boolean.ye_ruteinkai_shi
      state: "off"
  action:
    # 1. 帰宅時刻を19:00に設定
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.shi_ji_nogui_zhai_shi_guo
      data:
        time: "19:00:00"
    # 2. 夜ルーティン開始フラグをON
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.ye_ruteinkai_shi
    # 3. 日没後なら照明ON
    - condition: sun
      after: sunset
    - service: light.turn_on
      target:
        entity_id:
          - light.rihinku
          - light.lang_xia
    # 4. フォールバック通知
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "夜のルーティンを開始します。"
        language: ja

# -----------------------------------------------------------------------------
# 帰宅後作業（19:05）- 手洗い、着替え、洗濯準備、お風呂準備
# -----------------------------------------------------------------------------
- id: fixed_home_chores
  alias: "帰宅後作業（19:05）"
  description: "19:05に帰宅後の作業指示"
  trigger:
    - platform: time
      at: "19:05:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "手洗いうがい、着替え、洗濯物の準備をしてください。お風呂の掃除と沸かすボタンもお願いします。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "手洗いうがいをして、お着替えしてね。脱いだ服とカバンの服を洗濯機に入れてね。"
        language: ja

# -----------------------------------------------------------------------------
# 夕食開始（19:15）
# -----------------------------------------------------------------------------
- id: fixed_dinner_start
  alias: "夕食開始（19:15）"
  description: "19:15に夕食開始"
  trigger:
    - platform: time
      at: "19:15:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "夕食の時間です。いただきます。"
        language: ja

# -----------------------------------------------------------------------------
# 食器片付け（19:45）
# -----------------------------------------------------------------------------
- id: fixed_cleanup
  alias: "食器片付け（19:45）"
  description: "19:45に食器片付け"
  trigger:
    - platform: time
      at: "19:45:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "ごちそうさまでした。食器を片付けてください。"
        language: ja

# -----------------------------------------------------------------------------
# 入浴開始（19:50）
# -----------------------------------------------------------------------------
- id: fixed_bath_start
  alias: "入浴開始（19:50）"
  description: "19:50に入浴開始"
  trigger:
    - platform: time
      at: "19:50:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "お風呂の時間です。"
        language: ja

# -----------------------------------------------------------------------------
# 風呂上がり（20:05）- 保湿・パジャマ
# -----------------------------------------------------------------------------
- id: fixed_after_bath
  alias: "風呂上がり（20:05）"
  description: "20:05に風呂上がりの指示"
  trigger:
    - platform: time
      at: "20:05:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "お風呂お疲れさまでした。保湿クリームを塗ってパジャマに着替えてください。"
        language: ja

# -----------------------------------------------------------------------------
# 洗濯物干し・明日の準備（20:10）
# -----------------------------------------------------------------------------
- id: fixed_laundry_prep
  alias: "洗濯物干し・明日の準備（20:10）"
  description: "20:10に洗濯物干しと明日の準備"
  trigger:
    - platform: time
      at: "20:10:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "洗濯物を干して、明日の準備をしましょう。カバンに保育園の荷物を入れてください。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "自分の洗濯物を干してね。明日の準備もしてね。"
        language: ja

# -----------------------------------------------------------------------------
# 歯磨き・宿題（20:20）
# -----------------------------------------------------------------------------
- id: fixed_teeth_homework
  alias: "歯磨き・宿題（20:20）"
  description: "20:20に歯磨きと宿題"
  trigger:
    - platform: time
      at: "20:20:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "歯を磨いて、宿題をしましょう。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "歯を磨いてね。宿題もやってね。"
        language: ja
    # リビングサーキュレーターOFF（就寝準備）
    - service: button.press
      target:
        entity_id: button.send_signal_rihinkunosakiyureta

# -----------------------------------------------------------------------------
# トイレ・寝る準備（20:28）
# -----------------------------------------------------------------------------
- id: fixed_toilet_bedprep
  alias: "トイレ・寝る準備（20:28）"
  description: "20:28にトイレと寝る準備"
  trigger:
    - platform: time
      at: "20:28:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "トイレに行って、寝る準備をしてください。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "トイレに行って、ベッドに入る準備をしてね。"
        language: ja

# =============================================================================
# 父・就寝（固定時刻）
# =============================================================================

# -----------------------------------------------------------------------------
# 娘・就寝（20:30）- リビング消灯・TV電源OFF・子供部屋消灯
# -----------------------------------------------------------------------------
- id: fixed_daughter_bedtime
  alias: "娘・就寝準備（20:30）"
  description: "20:30にリビング消灯・廊下常夜灯・TV電源OFF"
  trigger:
    - platform: time
      at: "20:30:00"
  action:
    # リビング消灯
    - service: light.turn_off
      target:
        entity_id: light.rihinku
    # 廊下を常夜灯モードに
    - service: select.select_option
      target:
        entity_id: select.signals_lang_xia
      data:
        option: "4. night"
    - service: button.press
      target:
        entity_id: button.send_signal_lang_xia
    # TV電源OFF（LG TV + 電源プラグ）
    - service: media_player.turn_off
      target:
        entity_id: media_player.lg_webos_tv_55ur8000pjb
    - service: switch.turn_off
      target:
        entity_id: switch.rihinkuterehihuraku
    # リビングで寝室移動指示
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "就寝の時間です。寝室に移動しましょう。"
        language: ja
    - delay:
        seconds: 3
    # 子供部屋で寝室移動指示
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "寝室に移動してね。"
        language: ja

# -----------------------------------------------------------------------------
# 娘・消灯（20:45）- 子供部屋強制消灯
# -----------------------------------------------------------------------------
- id: fixed_daughter_lights_out
  alias: "娘・消灯（20:45）"
  description: "20:45に子供部屋消灯"
  trigger:
    - platform: time
      at: "20:45:00"
  action:
    # 子供部屋消灯（状態同期のため turn_on → turn_off）
    - service: light.turn_on
      target:
        entity_id: light.zi_gong_bu_wu
    - delay:
        seconds: 1
    - service: light.turn_off
      target:
        entity_id: light.zi_gong_bu_wu
    # おやすみ
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "おやすみなさい。"
        language: ja

# 父・就寝5分前（21:25）
- id: father_sleep_5min_before
  alias: "父・就寝5分前"
  trigger:
    - platform: time
      at: "21:25:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "就寝5分前です。"
        language: ja

# 父・就寝（21:30）- 全館消灯
- id: father_sleep
  alias: "父・就寝"
  description: "父の就寝時刻（廊下は常夜灯モードに切替）"
  trigger:
    - platform: time
      at: "21:30:00"
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.rihinku
          - light.qin_shi
          - light.shu_zhai
    - service: select.select_option
      target:
        entity_id: select.signals_lang_xia
      data:
        option: "4. night"
    - service: button.press
      target:
        entity_id: button.send_signal_lang_xia
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "おやすみなさい。"
        language: ja

# =============================================================================
# Phase 2: 夜泣き対応（2026年2月〜有効化）
# =============================================================================

- id: night_cry_detection
  alias: "夜泣き検知"
  description: "深夜に寝室照明がONになったら夜泣きモードを有効化"
  trigger:
    - platform: state
      entity_id: light.qin_shi
      to: "on"
  condition:
    - condition: time
      after: "00:00:00"
      before: "05:00:00"
  action:
    - service: input_boolean.turn_on
      target:
        entity_id: input_boolean.night_cry_mode
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.mother_wakeup_time
      data:
        time: "07:00:00"

- id: night_cry_reset
  alias: "夜泣きモードリセット"
  trigger:
    - platform: time
      at: "06:30:00"
  action:
    - service: input_boolean.turn_off
      target:
        entity_id: input_boolean.night_cry_mode
    - service: input_datetime.set_datetime
      target:
        entity_id: input_datetime.mother_wakeup_time
      data:
        time: "06:30:00"

# =============================================================================
# ユーティリティ
# =============================================================================

- id: holiday_mode_on
  alias: "休日モードON"
  trigger:
    - platform: event
      event_type: call_service
      event_data:
        domain: input_boolean
        service: turn_off
        service_data:
          entity_id: input_boolean.workday
  action:
    - service: automation.turn_off
      target:
        entity_id:
          - automation.father_wakeup
          - automation.daughter_wakeup

- id: father_away_mode
  alias: "父外出モード"
  trigger:
    - platform: state
      entity_id: input_boolean.father_home
      to: "off"
  action:
    - service: automation.turn_off
      target:
        entity_id:
          - automation.work_start
          - automation.pickup_reminder

# =============================================================================
# ゴミ出しリマインダー
# =============================================================================

- id: garbage_cardboard_reminder
  alias: "ゴミ出し・段ボール"
  description: "毎月第4土曜日の前日夜にリマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().weekday() == 4 and 22 <= (now().day + 1) <= 28 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は段ボールごみの日です。段ボールをまとめて出してください。"
        language: ja

- id: garbage_nonburnable_reminder
  alias: "ゴミ出し・燃えないゴミ/ペットボトル"
  description: "毎月第1・3・5木曜日の前日夜にリマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: >
        {{ now().weekday() == 2 and
           (1 <= (now().day + 1) <= 7 or
            15 <= (now().day + 1) <= 21 or
            29 <= (now().day + 1) <= 31) }}
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は燃えないゴミとペットボトルの日です。分別して出してください。"
        language: ja

- id: garbage_nonburnable_morning
  alias: "ゴミ出し・燃えないゴミ/ペットボトル（当日朝）"
  description: "第1・3木曜日の朝にリマインド"
  trigger:
    - platform: time
      at: "05:50:00"
  condition:
    - condition: template
      value_template: >
        {{ now().weekday() == 3 and
           (1 <= now().day <= 7 or
            15 <= now().day <= 21) }}
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "今日は燃えないゴミとペットボトルの日です。出発前に出してください。"
        language: ja

- id: garbage_bulky_20260127
  alias: "ゴミ出し・粗大ごみ（2026/1/27）"
  description: "2026年1月27日の粗大ごみ収集前日リマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().month == 1 and now().day == 26 and now().year == 2026 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は粗大ごみの収集日です。出す予定のものを玄関に準備してください。"
        language: ja

# =============================================================================
# お弁当の日リマインダー
# =============================================================================

- id: bento_prep_reminder
  alias: "お弁当・前日準備"
  description: "毎月第3水曜日の前日夜にリマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().weekday() == 1 and 15 <= (now().day + 1) <= 21 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日はお弁当の日です。お弁当の材料を確認して、準備をお願いします。"
        language: ja

- id: bento_morning_reminder
  alias: "お弁当・当日朝"
  description: "毎月第3水曜日の朝にリマインド"
  trigger:
    - platform: time
      at: "05:50:00"
  condition:
    - condition: template
      value_template: "{{ now().weekday() == 2 and 15 <= now().day <= 21 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "今日はお弁当の日です。お弁当の準備を忘れずに。"
        language: ja

# =============================================================================
# 週次・月次習慣リマインダー
# =============================================================================

# 土曜日・タオル交換（07:00）
- id: weekly_towel_change
  alias: "週次・タオル交換"
  description: "毎週土曜日の朝にタオル交換リマインド"
  trigger:
    - platform: time
      at: "07:00:00"
  condition:
    - condition: time
      weekday:
        - sat
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "土曜日です。家中のタオルを新しいものに交換しましょう。"
        language: ja

# 土曜日・シーツ洗濯（07:00）
- id: weekly_sheets_laundry
  alias: "週次・シーツ洗濯"
  description: "毎週土曜日の朝にシーツ洗濯リマインド"
  trigger:
    - platform: time
      at: "07:00:00"
  condition:
    - condition: time
      weekday:
        - sat
  action:
    - delay:
        seconds: 10
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "みんなで布団のシーツを外して洗濯機に入れましょう。"
        language: ja
    - delay:
        seconds: 3
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.zi_gong_bu_wu
        message: "シーツを外してね。お手伝いお願いします。"
        language: ja

# 毎月1日・消耗品交換（06:00）
- id: monthly_consumables_change
  alias: "月次・消耗品交換"
  description: "毎月1日の朝に消耗品交換リマインド"
  trigger:
    - platform: time
      at: "06:00:00"
  condition:
    - condition: template
      value_template: "{{ now().day == 1 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "月初めです。歯ブラシ、食器スポンジなどの消耗品を新しいものに交換しましょう。"
        language: ja

# =============================================================================
# 特別イベントリマインダー
# =============================================================================

- id: event_performance_prep_20260207
  alias: "発表会・前日準備（2026/2/7）"
  description: "2026年2月7日の発表会前日リマインド"
  trigger:
    - platform: time
      at: "21:00:00"
  condition:
    - condition: template
      value_template: "{{ now().year == 2026 and now().month == 2 and now().day == 6 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "明日は発表会です。衣装と持ち物を確認して、早めに寝ましょう。"
        language: ja

- id: event_performance_day_20260207
  alias: "発表会・当日（2026/2/7）"
  description: "2026年2月7日の発表会当日リマインド"
  trigger:
    - platform: time
      at: "06:00:00"
  condition:
    - condition: template
      value_template: "{{ now().year == 2026 and now().month == 2 and now().day == 7 }}"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "今日は発表会です。がんばってね！衣装と持ち物を忘れずに。"
        language: ja

# =============================================================================
# GPS/プレゼンス連動
# =============================================================================

- id: gps_leaving_home
  alias: "GPS・外出検知"
  description: "外出5分後に書斎の照明をOFF"
  trigger:
    - platform: state
      entity_id: person.ri_xia
      from: "home"
      to: "not_home"
      for:
        minutes: 5
  action:
    - service: light.turn_off
      target:
        entity_id: light.shu_zhai

# =============================================================================
# サーキュレーター時間制御
# =============================================================================

- id: circulator_morning_on
  alias: "サーキュレーター・朝ON"
  description: "朝5:50にリビングのサーキュレーター起動"
  trigger:
    - platform: time
      at: "05:50:00"
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
  action:
    # リビングのみ（他の部屋は操作不要）
    - service: button.press
      target:
        entity_id: button.send_signal_rihinkunosakiyureta

# 夕方・サーキュレーターOFF（18:00）
- id: circulator_evening_off
  alias: "サーキュレーター・夕方OFF"
  description: "18時にリビングのサーキュレーター停止"
  trigger:
    - platform: time
      at: "18:00:00"
  action:
    # リビングのみ（他の部屋は操作不要）
    - service: button.press
      target:
        entity_id: button.send_signal_rihinkunosakiyureta

# =============================================================================
# 温度アラート
# =============================================================================

- id: temperature_alert_living_high
  alias: "温度アラート・リビング高温"
  description: "リビングが28℃を超えたら音声通知"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_sensor_rihinku
      above: 28
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
    - condition: time
      after: "06:00:00"
      before: "21:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "リビングの室温が{{ states('sensor.temperature_sensor_rihinku') }}度です。エアコンの使用を検討してください。"
        language: ja

- id: temperature_alert_study_high
  alias: "温度アラート・書斎高温"
  description: "書斎が28℃を超えたら音声通知"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_sensor_shu_zhai
      above: 28
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
    - condition: time
      after: "06:00:00"
      before: "21:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_nohea
        message: "書斎の室温が{{ states('sensor.temperature_sensor_shu_zhai') }}度です。エアコンの使用を検討してください。"
        language: ja

- id: temperature_alert_living_low
  alias: "温度アラート・リビング低温"
  description: "リビングが15℃以下になったら音声通知"
  trigger:
    - platform: numeric_state
      entity_id: sensor.temperature_sensor_rihinku
      below: 15
      for:
        minutes: 10
  condition:
    - condition: state
      entity_id: person.ri_xia
      state: "home"
    - condition: time
      after: "06:00:00"
      before: "21:00:00"
  action:
    - service: tts.speak
      target:
        entity_id: tts.google_translate_en_com
      data:
        media_player_entity_id: media_player.shu_zhai_hetuto_hou_you
        message: "リビングの室温が{{ states('sensor.temperature_sensor_rihinku') }}度です。暖房の使用を検討してください。"
        language: ja

# =============================================================================
# スピーカー音量制御
# =============================================================================
# 音量レベル: 朝(0.7) → 夕方(0.5) → 夜(0.3)

# 朝・音量UP（05:40）- 起床時刻に合わせて大きめ
- id: speaker_volume_morning
  alias: "スピーカー音量・朝"
  description: "朝は音量を大きく（70%）"
  trigger:
    - platform: time
      at: "05:40:00"
  action:
    - service: media_player.volume_set
      target:
        entity_id:
          - media_player.shu_zhai_nohea
          - media_player.shu_zhai_hetuto_hou_you
          - media_player.zi_gong_bu_wu
      data:
        volume_level: 0.7

# 夕方・音量NORMAL（17:00）- 帰宅前に通常に戻す
- id: speaker_volume_evening
  alias: "スピーカー音量・夕方"
  description: "夕方は音量を普通に（50%）"
  trigger:
    - platform: time
      at: "17:00:00"
  action:
    - service: media_player.volume_set
      target:
        entity_id:
          - media_player.shu_zhai_nohea
          - media_player.shu_zhai_hetuto_hou_you
          - media_player.zi_gong_bu_wu
      data:
        volume_level: 0.5

# 夜・音量DOWN（21:00）- 娘就寝後は小さく
- id: speaker_volume_night
  alias: "スピーカー音量・夜"
  description: "夜は音量を小さく（30%）"
  trigger:
    - platform: time
      at: "21:00:00"
  action:
    - service: media_player.volume_set
      target:
        entity_id:
          - media_player.shu_zhai_nohea
          - media_player.shu_zhai_hetuto_hou_you
          - media_player.zi_gong_bu_wu
      data:
        volume_level: 0.3

# =============================================================================
# テレビ電源制御（Tapo P110M）
# =============================================================================
# 18:00〜06:00はテレビ視聴禁止（子供の生活リズム維持）

# 朝・テレビ電源ON（06:00）- ラジオ体操準備
- id: tv_power_morning_on
  alias: "テレビ電源・朝ON"
  description: "朝6時にテレビ電源ON（ラジオ体操用）"
  trigger:
    - platform: time
      at: "06:00:00"
  action:
    - service: switch.turn_on
      target:
        entity_id: switch.rihinkuterehihuraku

# 夕方・テレビ電源OFF（18:00）- 夜間視聴禁止
- id: tv_power_evening_off
  alias: "テレビ電源・夕方OFF"
  description: "18時にテレビ電源OFF（夜間視聴禁止）"
  trigger:
    - platform: time
      at: "18:00:00"
  action:
    - service: switch.turn_off
      target:
        entity_id: switch.rihinkuterehihuraku

# =============================================================================
# エアコン自動OFF（就寝時）
# =============================================================================

# 21時・エアコン全OFF（就寝準備）
- id: aircon_off_bedtime
  alias: "エアコン・就寝時OFF"
  description: "21時に全エアコンをOFF（就寝中の節電）"
  trigger:
    - platform: time
      at: "21:00:00"
  action:
    - service: climate.turn_off
      target:
        entity_id:
          - climate.qin_shi_noeakon_remo
          - climate.rihinkunoeakon_rihinku
          - climate.shu_zhai_noeakon_shu_zhai
          - climate.zi_gong_bu_wu_noeakon_lang_xia
